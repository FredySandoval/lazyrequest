name: Release Build

on:
  workflow_dispatch:
    inputs:
      bump:
        type: choice
        options: [major, minor, patch]
      version:
        type: string
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-package:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Resolve release version
        run: |
          set -euo pipefail

          base_version="$(bun -e "import pkg from './package.json'; console.log(pkg.version)")"
          input_version="${{ github.event.inputs.version || '' }}"
          bump="${{ github.event.inputs.bump || '' }}"
          ref_name="${{ github.ref_name }}"
          ref_type="${{ github.ref_type }}"

          if [ "$ref_type" = "tag" ]; then
            version="${ref_name#v}"
          elif [ -n "$input_version" ]; then
            version="$input_version"
          elif [ -n "$bump" ]; then
            bun -e "
              import pkg from './package.json';
              const bump = process.argv[1];
              const parts = String(pkg.version).split('.').map((x) => Number(x));
              if (parts.length !== 3 || parts.some(Number.isNaN)) {
                throw new Error('package.json version must be semver major.minor.patch');
              }
              let [major, minor, patch] = parts;
              if (bump === 'major') { major += 1; minor = 0; patch = 0; }
              else if (bump === 'minor') { minor += 1; patch = 0; }
              else if (bump === 'patch') { patch += 1; }
              else { throw new Error('Invalid bump input'); }
              console.log(\`\${major}.\${minor}.\${patch}\`);
            " "$bump" > /tmp/release_version.txt
            version="$(cat /tmp/release_version.txt)"
          else
            version="$base_version"
          fi

          if ! echo "$version" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+([-.][0-9A-Za-z.-]+)?$'; then
            echo "Invalid release version: $version"
            exit 1
          fi

          echo "RELEASE_VERSION=$version" >> "$GITHUB_ENV"
          echo "RELEASE_TAG=v$version" >> "$GITHUB_ENV"

      - name: Build targets
        run: bun run build

      - name: Package targets
        run: bun run package

      - name: Upload packaged artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-packages
          path: |
            dist/**/*.zip
            dist/**/*.tar.gz

      - name: Setup Node for npm publish
        if: github.event_name == 'workflow_dispatch' || github.ref_type == 'tag'
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          registry-url: "https://registry.npmjs.org"

      - name: Publish to npm registry
        if: github.event_name == 'workflow_dispatch' || github.ref_type == 'tag'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: "false"
          NPM_CONFIG_CACHE: /tmp/npm-cache
          RELEASE_VERSION: ${{ env.RELEASE_VERSION }}
        run: bun run publish:npm

      - name: Create or update GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          if gh release view "$RELEASE_TAG" >/dev/null 2>&1; then
            echo "Release $RELEASE_TAG already exists"
          else
            gh release create "$RELEASE_TAG" \
              --title "$RELEASE_TAG" \
              --generate-notes
          fi

      - name: Upload packaged binaries to release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          gh release upload "$RELEASE_TAG" dist/*.zip dist/*.tar.gz --clobber
